import moment from "moment";
import React, { useEffect, useRef, useState } from "react";
import useModal from "../../hooks/useModal";
import { FaArrowUp, FaArrowDown } from "react-icons/fa";

interface DataRow {
  [key: string]: any;
}

interface Column<T extends DataRow> {
  header: string;
  // Key to access data in the row object, or a custom render function
  accessor: keyof T | ((row: T) => React.ReactNode);
  // Custom cell class for alignment/width
  cellClass?: string;
  // Custom header class for alignment/width
  headerClass?: string;
  // Defines if the column should wrap content or take full width
  minWidth?: string;
}

// Column definition for flexibility
interface Column<T extends DataRow> {
  header: string;
  // Key to access data in the row object, or a custom render function
  accessor: keyof T | ((row: T) => React.ReactNode);
  // Custom cell class for alignment/width
  cellClass?: string;
  // Custom header class for alignment/width
  headerClass?: string;
  // Defines if the column should wrap content or take full width
  minWidth?: string;
}

interface CustomTableProps<T extends DataRow> {
  data: T[];
  columns: Column<T>[];
  // Handler for row click (Enter key or double click)
  handleRowAction: (row: T) => void;
  // Handler for secondary action (Ctrl+P)
  handleSecondaryAction: (row: T) => void;
  // Prop to control if the table should respond to keyboard navigation
  keyboardNavigationEnabled?: boolean;
  // Optional modal state check to disable keyboard nav when a modal is open
  modalIsOpen?: boolean;
}

const DashboardPageTable = <T extends DataRow>({
  data,
  columns,
  handleRowAction,
  handleSecondaryAction,
  keyboardNavigationEnabled = true,
  modalIsOpen = false,
}: CustomTableProps<T>) => {
  const [selectedRow, setSelectedRow] = useState(0);
  const tableContainerRef = useRef<HTMLDivElement>(null);

  // --- Keyboard Navigation Logic ---
  useEffect(() => {
    // Scroll selected row into view
    const scrollIntoView = () => {
      if (tableContainerRef.current) {
        const selectedElement = tableContainerRef.current.querySelector(
          `tr[data-index="${selectedRow}"]`
        );
        selectedElement?.scrollIntoView({
          behavior: "smooth",
          block: "nearest",
        });
      }
    };

    scrollIntoView();
  }, [selectedRow]);

  useEffect(() => {
    const handleKeyDown = (event: KeyboardEvent) => {
      if (!keyboardNavigationEnabled || modalIsOpen) return;
      if (!data || data.length === 0) return;

      if (event.key === "ArrowDown") {
        event.preventDefault();
        setSelectedRow((prev) => Math.min(prev + 1, data.length - 1));
      } else if (event.key === "ArrowUp") {
        event.preventDefault();
        setSelectedRow((prev) => Math.max(prev - 1, 0));
      } else if (event.key === "Enter") {
        event.preventDefault();
        if (data[selectedRow]) {
          handleRowAction(data[selectedRow]);
        }
      } else if (event.ctrlKey && event.key === "p") {
        event.preventDefault();
        if (data[selectedRow]) {
          handleSecondaryAction(data[selectedRow]);
        }
      }
    };

    window.addEventListener("keydown", handleKeyDown);
    return () => {
      window.removeEventListener("keydown", handleKeyDown);
    };
  }, [
    selectedRow,
    data,
    handleRowAction,
    handleSecondaryAction,
    keyboardNavigationEnabled,
    modalIsOpen,
  ]);

  // Reset selection when data changes
  useEffect(() => {
    setSelectedRow(0);
  }, [data]);

  // Helper function to format date without moment.js
  const formatDate = (dateValue: string | Date | number): string => {
    try {
      const date = new Date(dateValue);
      // Use native toLocaleDateString for "MMM DD, YYYY" format
      return date.toLocaleDateString("en-US", {
        year: "numeric",
        month: "short",
        day: "2-digit",
      });
    } catch (e) {
      return String(dateValue); // Return original value if formatting fails
    }
  };

  // Helper to render cell content
  const renderCell = (row: T, column: Column<T>) => {
    if (typeof column.accessor === "function") {
      return column.accessor(row);
    }
    // Default accessor for simple key-based data
    const value = row[column.accessor as keyof T];

    // Handle specific formatting for common types if accessor is a string key
    const accessorKey = column.accessor.toString().toLowerCase();

    if (accessorKey.includes("date") || accessorKey.includes("createdat")) {
      return formatDate(value);
    }

    if (
      accessorKey.includes("amount") ||
      accessorKey.includes("due") ||
      accessorKey.includes("paid")
    ) {
      // Simple currency formatting placeholder
      const numberValue = parseFloat(value);
      if (!isNaN(numberValue)) {
        // Using Intl.NumberFormat for robust currency display
        return new Intl.NumberFormat("en-IN", {
          style: "currency",
          currency: "INR",
          minimumFractionDigits: 2,
        }).format(numberValue);
      }
    }
    return value;
  };

  return (
    <section className="">
      <div
        ref={tableContainerRef}
        className="h-[calc(100vh-130px)] overflow-x-auto border border-primary-600 md:rounded-lg"
      >
        <table className="min-w-full divide-y divide-primary-600 ">
          <thead className="bg-primary-800 text-white sticky top-0 ">
            <tr>
              {columns.map((column, index) => (
                <th
                  key={index}
                  scope="col"
                  // minWidth can be provided in the column definition
                  style={{ minWidth: column.minWidth || "8rem" }}
                  className={`
                    px-4 py-3 text-xs font-semibold uppercase tracking-wider text-left 
                    ${
                      column.headerClass || "text-lightText dark:text-lightText"
                    }
                  `}
                >
                  {column.header}
                </th>
              ))}
            </tr>
          </thead>
          <tbody className="bg-primary-50 divide-y divide-gray-200">
            {data && data.length > 0 ? (
              data?.map((invoice, index) => {
                return (
                  <tr
                    key={index}
                    data-index={index}
                    onDoubleClick={() => handleRowAction(invoice)}
                    onClick={() => setSelectedRow(index)}
                    className={`cursor-pointer hover:bg-primary-200 ${
                      selectedRow === index ? "bg-primary-300" : ""
                    }`}
                  >
                    {columns.map((column, colIndex) => (
                      <td
                        key={colIndex}
                        style={{ minWidth: column.minWidth || "8rem" }}
                        className={`
                        px-4 py-2.5 text-sm whitespace-nowrap 
                        ${column.cellClass || "font-medium"}
                      `}
                      >
                        {renderCell(invoice, column)}
                      </td>
                    ))}
                    {/* <td className=" flex gap-2 items-center px-2 py-[2px] text-sm font-normal whitespace-nowrap">
                    <button
                      type="button"
                      onClick={() => handleTableRowClick(invoice)}
                      className="bg-primary-900 hover:bg-primary-800 text-white px-4 py-[2px] rounded-md active:scale-95 transition-all duration-300"
                    >
                      Details
                    </button>
                    <button
                      type="button"
                      onClick={() => handlePaymentClick(invoice)}
                      className="bg-primary-900 hover:bg-primary-800 text-white px-4 py-[2px] rounded-md active:scale-95 transition-all duration-300"
                    >
                      Pay
                    </button>
                  </td> */}
                  </tr>
                );
              })
            ) : (
              <tr>
                <td
                  colSpan={columns.length}
                  className="py-8 text-center text-lg text-primary-700 dark:text-primary-300"
                >
                  No data available.
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>

      <div className="mt-4 flex justify-between items-center text-xs text-primary-700 dark:text-primary-300">
        <div className="flex items-center gap-3">
          <span className="font-semibold text-sm">Keyboard Navigation:</span>
          <span className="flex items-center bg-gray-200 dark:bg-darkBorder px-2 py-0.5 rounded-full">
            <FaArrowUp size={14} /> / <FaArrowDown size={14} />
          </span>
          <span className="text-sm">to Select</span>
        </div>
        <div className="flex items-center gap-3">
          <span className="bg-gray-200 dark:bg-darkBorder px-2 py-0.5 rounded-full text-sm font-mono">
            Enter
          </span>
          <span className="text-sm">for Details</span>
        </div>
        <div className="flex items-center gap-3">
          <span className="bg-gray-200 dark:bg-darkBorder px-2 py-0.5 rounded-full text-sm font-mono">
            Ctrl + P
          </span>
          <span className="text-sm">for Payment</span>
        </div>
      </div>
    </section>
  );
};

export default DashboardPageTable;
